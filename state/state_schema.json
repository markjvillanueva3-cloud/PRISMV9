{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PRISM Append-Only State Schema",
  "description": "Schema for append-only state persistence with event sourcing",
  "version": "1.0.0",
  
  "definitions": {
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp"
    },
    
    "eventType": {
      "type": "string",
      "enum": [
        "STATE_INIT",
        "STATE_UPDATE",
        "STATE_PATCH",
        "CHECKPOINT_CREATE",
        "CHECKPOINT_RESTORE",
        "SESSION_START",
        "SESSION_END",
        "TASK_START",
        "TASK_COMPLETE",
        "TASK_FAIL",
        "PROGRESS_UPDATE",
        "DECISION_RECORD",
        "ERROR_LOG",
        "ROLLBACK",
        "COMPACT"
      ]
    },
    
    "event": {
      "type": "object",
      "required": ["id", "type", "timestamp", "data"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^EVT-[0-9]{8}-[0-9]{6}-[0-9]{4}$",
          "description": "Unique event ID: EVT-YYYYMMDD-HHMMSS-NNNN"
        },
        "type": { "$ref": "#/definitions/eventType" },
        "timestamp": { "$ref": "#/definitions/timestamp" },
        "sequence": {
          "type": "integer",
          "minimum": 0,
          "description": "Monotonically increasing sequence number"
        },
        "sessionId": {
          "type": "string",
          "description": "Session that generated this event"
        },
        "parentEventId": {
          "type": ["string", "null"],
          "description": "Previous event ID for chain linking"
        },
        "data": {
          "type": "object",
          "description": "Event-specific payload"
        },
        "checksum": {
          "type": "string",
          "description": "SHA-256 of id+type+timestamp+data for integrity"
        }
      }
    },
    
    "checkpoint": {
      "type": "object",
      "required": ["id", "timestamp", "sequence", "state"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^CP-[0-9]{8}-[0-9]{6}$",
          "description": "Checkpoint ID: CP-YYYYMMDD-HHMMSS"
        },
        "timestamp": { "$ref": "#/definitions/timestamp" },
        "sequence": {
          "type": "integer",
          "description": "Event sequence at checkpoint time"
        },
        "eventId": {
          "type": "string",
          "description": "Last event ID included in checkpoint"
        },
        "state": {
          "type": "object",
          "description": "Full state snapshot at checkpoint"
        },
        "checksum": {
          "type": "string",
          "description": "SHA-256 of state for integrity verification"
        },
        "type": {
          "type": "string",
          "enum": ["AUTO", "MANUAL", "EMERGENCY", "SESSION_END"],
          "default": "AUTO"
        }
      }
    },
    
    "stateVersion": {
      "type": "object",
      "required": ["version", "sequence", "lastEventId", "lastCheckpointId"],
      "properties": {
        "version": {
          "type": "string",
          "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
          "description": "Semantic version of state"
        },
        "sequence": {
          "type": "integer",
          "description": "Current event sequence number"
        },
        "lastEventId": {
          "type": "string",
          "description": "Most recent event ID"
        },
        "lastCheckpointId": {
          "type": "string",
          "description": "Most recent checkpoint ID"
        },
        "eventCount": {
          "type": "integer",
          "description": "Total events since last compaction"
        },
        "checkpointCount": {
          "type": "integer",
          "description": "Total checkpoints"
        }
      }
    }
  },
  
  "type": "object",
  "required": ["meta", "version", "events", "checkpoints", "currentState"],
  "properties": {
    "meta": {
      "type": "object",
      "required": ["schema", "created", "lastModified"],
      "properties": {
        "schema": {
          "type": "string",
          "const": "prism-append-only-state-v1"
        },
        "created": { "$ref": "#/definitions/timestamp" },
        "lastModified": { "$ref": "#/definitions/timestamp" },
        "compactedAt": { "$ref": "#/definitions/timestamp" },
        "compactedFromSequence": { "type": "integer" }
      }
    },
    
    "version": { "$ref": "#/definitions/stateVersion" },
    
    "events": {
      "type": "array",
      "items": { "$ref": "#/definitions/event" },
      "description": "Append-only event log"
    },
    
    "checkpoints": {
      "type": "array",
      "items": { "$ref": "#/definitions/checkpoint" },
      "description": "State snapshots for fast recovery"
    },
    
    "currentState": {
      "type": "object",
      "description": "Materialized view of current state (rebuilt from events)"
    }
  },
  
  "eventDataSchemas": {
    "STATE_INIT": {
      "required": ["initialState"],
      "properties": {
        "initialState": { "type": "object" },
        "source": { "type": "string" }
      }
    },
    "STATE_UPDATE": {
      "required": ["path", "value"],
      "properties": {
        "path": { "type": "string", "description": "JSON path to update" },
        "value": { "description": "New value" },
        "previousValue": { "description": "Old value for rollback" }
      }
    },
    "STATE_PATCH": {
      "required": ["patch"],
      "properties": {
        "patch": { "type": "object", "description": "JSON merge patch" }
      }
    },
    "CHECKPOINT_CREATE": {
      "required": ["checkpointId"],
      "properties": {
        "checkpointId": { "type": "string" },
        "reason": { "type": "string" }
      }
    },
    "PROGRESS_UPDATE": {
      "required": ["completed", "total"],
      "properties": {
        "completed": { "type": "integer" },
        "total": { "type": "integer" },
        "currentItem": { "type": "string" },
        "percentage": { "type": "number" }
      }
    },
    "ROLLBACK": {
      "required": ["targetCheckpointId"],
      "properties": {
        "targetCheckpointId": { "type": "string" },
        "reason": { "type": "string" },
        "eventsDiscarded": { "type": "integer" }
      }
    }
  }
}
