{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PRISM Session Handoff Schema",
  "description": "Schema for session handoff with complete context transfer",
  "version": "1.0.0",
  
  "definitions": {
    "timestamp": {
      "type": "string",
      "format": "date-time"
    },
    
    "contextPressure": {
      "type": "string",
      "enum": ["GREEN", "YELLOW", "ORANGE", "RED", "CRITICAL"],
      "description": "Context window pressure level"
    },
    
    "handoffType": {
      "type": "string",
      "enum": [
        "GRACEFUL",
        "CHECKPOINT",
        "EMERGENCY",
        "SCHEDULED",
        "USER_REQUESTED"
      ]
    },
    
    "wipItem": {
      "type": "object",
      "required": ["id", "description", "status"],
      "properties": {
        "id": {"type": "string"},
        "description": {"type": "string"},
        "status": {"type": "string", "enum": ["NOT_STARTED", "IN_PROGRESS", "BLOCKED", "COMPLETE"]},
        "progress": {
          "type": "object",
          "properties": {
            "completed": {"type": "integer"},
            "total": {"type": "integer"},
            "percentage": {"type": "number"}
          }
        },
        "files": {"type": "array", "items": {"type": "string"}},
        "blockers": {"type": "array", "items": {"type": "string"}},
        "notes": {"type": "string"}
      }
    },
    
    "decision": {
      "type": "object",
      "properties": {
        "id": {"type": "string"},
        "decision": {"type": "string"},
        "rationale": {"type": "string"},
        "alternatives": {"type": "array", "items": {"type": "string"}},
        "timestamp": {"$ref": "#/definitions/timestamp"}
      }
    }
  },
  
  "type": "object",
  "required": ["meta", "currentState", "workInProgress", "nextSession"],
  "properties": {
    "meta": {
      "type": "object",
      "required": ["schema", "handoffType", "timestamp"],
      "properties": {
        "schema": {"const": "prism-handoff-v1"},
        "handoffType": {"$ref": "#/definitions/handoffType"},
        "timestamp": {"$ref": "#/definitions/timestamp"},
        "reason": {"type": "string"},
        "contextPressure": {"$ref": "#/definitions/contextPressure"},
        "sessionDuration": {"type": "integer", "description": "Duration in seconds"},
        "messageCount": {"type": "integer"}
      }
    },
    
    "currentState": {
      "type": "object",
      "properties": {
        "summary": {
          "type": "string",
          "maxLength": 500,
          "description": "What was accomplished this session"
        },
        "roadmapPosition": {
          "type": "object",
          "properties": {
            "tier": {"type": "integer"},
            "session": {"type": "string"},
            "sessionName": {"type": "string"},
            "deliverablesDone": {"type": "array", "items": {"type": "string"}},
            "deliverablesPending": {"type": "array", "items": {"type": "string"}}
          }
        },
        "stateVersion": {"type": "string"},
        "checkpointId": {"type": "string"},
        "eventSequence": {"type": "integer"}
      }
    },
    
    "workInProgress": {
      "type": "object",
      "properties": {
        "activeTask": {"$ref": "#/definitions/wipItem"},
        "pendingTasks": {
          "type": "array",
          "items": {"$ref": "#/definitions/wipItem"}
        },
        "partialFiles": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "path": {"type": "string"},
              "status": {"type": "string"},
              "completionPercentage": {"type": "number"},
              "lastEditLine": {"type": "integer"}
            }
          }
        },
        "uncommittedChanges": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    
    "decisions": {
      "type": "object",
      "properties": {
        "thisSession": {
          "type": "array",
          "items": {"$ref": "#/definitions/decision"}
        },
        "pending": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Decisions that need to be made"
        }
      }
    },
    
    "nextSession": {
      "type": "object",
      "required": ["immediateAction", "context"],
      "properties": {
        "immediateAction": {
          "type": "string",
          "maxLength": 200,
          "description": "EXACT first thing to do"
        },
        "context": {
          "type": "string",
          "maxLength": 1000,
          "description": "All context needed to continue"
        },
        "warnings": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Things to watch out for"
        },
        "doNotForget": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Critical items that must not be lost"
        },
        "skillsNeeded": {
          "type": "array",
          "items": {"type": "string"}
        },
        "filesNeeded": {
          "type": "array",
          "items": {"type": "string"}
        },
        "estimatedComplexity": {
          "type": "string",
          "enum": ["TRIVIAL", "SIMPLE", "MODERATE", "COMPLEX", "VERY_COMPLEX"]
        }
      }
    },
    
    "recovery": {
      "type": "object",
      "properties": {
        "lkgCheckpointId": {"type": "string"},
        "lastGoodSequence": {"type": "integer"},
        "rollbackInstructions": {"type": "string"}
      }
    }
  }
}
