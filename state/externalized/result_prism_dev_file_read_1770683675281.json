{"path":"scripts/convert_to_ts.js","total_lines":150,"showing":"1-101","content":"const fs = require('fs');\nconst path = require('path');\n\nconst srcDir = path.join(__dirname, '..', 'src', 'tools');\nconst recovered = fs.readFileSync(path.join(srcDir, 'autoHookWrapper.recovered.js'), 'utf-8');\nconst lines = recovered.split('\\n');\n\n// TypeScript imports header\nconst imports = `/**\n * autoHookWrapper.ts — Universal hook/cadence system\n * RECOVERED from dist/index.js bundle on ${new Date().toISOString()}\n * Original was accidentally wiped by file_write str_replace bug.\n */\nimport * as fs from \"fs\";\nimport * as path from \"path\";\nimport { execSync } from \"child_process\";\nimport {\n  HookResult, ToolCallContext, ProofValidation, FactVerify,\n  HookExecution, RecordedAction, CompactionSurvivalData\n} from \"../types/prism-schema.js\";\nimport { HookExecutor } from \"../engines/HookExecutor.js\";\nimport {\n  autoTodoRefresh, autoCheckpoint, autoContextPressure,\n  autoContextCompress, autoCompactionDetect, autoCompactionSurvival,\n  rehydrateFromSurvival, autoAttentionScore, autoContextPullBack,\n  getCurrentPressurePct\n} from \"./cadenceExecutor.js\";\nimport { slimJsonResponse, slimCadence, getSlimLevel } from \"../utils/responseSlimmer.js\";\nimport { autoSkillHint, autoKnowledgeCrossQuery } from \"./cadenceExecutor.js\";\nimport { TelemetryEngine } from \"../engines/TelemetryEngine.js\";\nimport { MemoryGraphEngine } from \"../engines/MemoryGraphEngine.js\";\nimport { PredictiveFailureEngine } from \"../engines/PredictiveFailureEngine.js\";\n\n// Engine singletons (initialized on first use)\nconst hookExecutor = new HookExecutor();\nlet telemetryEngine: TelemetryEngine | null = null;\nlet memoryGraphEngine: MemoryGraphEngine | null = null;\nlet pfpEngine: PredictiveFailureEngine | null = null;\n\nfunction getTelemetry(): TelemetryEngine {\n  if (!telemetryEngine) telemetryEngine = TelemetryEngine.getInstance();\n  return telemetryEngine;\n}\nfunction getMemoryGraph(): MemoryGraphEngine {\n  if (!memoryGraphEngine) memoryGraphEngine = MemoryGraphEngine.getInstance();\n  return memoryGraphEngine;\n}\nfunction getPFP(): PredictiveFailureEngine {\n  if (!pfpEngine) pfpEngine = PredictiveFailureEngine.getInstance();\n  return pfpEngine;\n}\n`;\n\n// Process the recovered JS:\n// 1. Remove esbuild require wrappers\n// 2. Remove init calls that are handled by imports\n// 3. Add export to known exported functions\n// 4. Fix variable names (fs15→fs, path17→path)\n\nlet code = lines.join('\\n');\n\n// Remove the esbuild module boundary comment\ncode = code.replace(/^\\/\\/ src\\/tools\\/autoHookWrapper\\.ts\\n/, '');\n\n// Remove esbuild require lines\ncode = code.replace(/var fs\\d+ = __toESM\\(require\\(\"fs\"\\)\\);\\n/g, '');\ncode = code.replace(/var path\\d+ = __toESM\\(require\\(\"path\"\\)\\);\\n/g, '');\ncode = code.replace(/init_TelemetryEngine\\(\\);\\n/g, '');\n\n// Replace numbered fs/path references with plain ones\ncode = code.replace(/\\bfs\\d+\\b/g, 'fs');\ncode = code.replace(/\\bpath\\d+\\b/g, 'path');\n\n// Add export to known exported functions\nconst exportFns = [\n  'function wrapToolWithAutoHooks',\n  'function wrapWithUniversalHooks',\n  'function getDispatchCount',\n  'function getAccumulatedBytes',\n  'function resetReconFlag',\n  'function resetDispatchCount',\n  'function getHookHistory',\n  'function registerAutoHookTools',\n  'function validateSafetyProof',\n  'function fireHook',\n  'function verifyFactualClaims'\n];\nfor (const fn of exportFns) {\n  code = code.replace(new RegExp(`^(${fn.replace(/[.*+?^${}()|[\\\\]\\\\]/g, '\\\\$&')})`, 'm'), 'export $1');\n}\n\n// Export the config\ncode = code.replace(/^var AUTO_HOOK_CONFIG/m, 'export var AUTO_HOOK_CONFIG');\n\n// Fix void 0 → undefined\ncode = code.replace(/void 0/g, 'undefined');\n\n// === APPLY THE BUFFER ZONE FIX ===\n// Replace old call-count-based caps with advisory-only\nconst oldBuffer = `    if (callNum >= 19) {"}