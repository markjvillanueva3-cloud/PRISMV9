{
  "path": "../state/externalized/result_prism_dev_file_read_1770498996482.json",
  "total_lines": 6,
  "showing": "0-6",
  "content": "{\n  \"path\": \"src/index.ts\",\n  \"total_lines\": 511,\n  \"showing\": \"1-511\",\n  \"content\": \" * PRISM MCP Server - Main Entry Point\\n * Manufacturing Intelligence MCP Server\\n * \\n * Provides access to:\\n * - Materials Database (1,047+ materials × 127 parameters)\\n * - Machines Database (824+ machines × 4 layers)\\n * - Controller Alarms (2,500+ alarms × 12 families)\\n * - Manufacturing Calculations (Kienzle, Taylor, etc.)\\n * - AI Agent Orchestration (64 agents)\\n * - Skills & Knowledge Base (135+ skills)\\n */\\n\\nimport { McpServer } from \\\"@modelcontextprotocol/sdk/server/mcp.js\\\";\\nimport { StdioServerTransport } from \\\"@modelcontextprotocol/sdk/server/stdio.js\\\";\\nimport { StreamableHTTPServerTransport } from \\\"@modelcontextprotocol/sdk/server/streamableHttp.js\\\";\\nimport express from \\\"express\\\";\\nimport dotenv from \\\"dotenv\\\";\\n\\nimport { SERVER_NAME, SERVER_VERSION, SERVER_DESCRIPTION } from \\\"./constants.js\\\";\\nimport { log } from \\\"./utils/Logger.js\\\";\\n\\n// Import tool registrations\\n// BATCH 2 DONE: registerDataAccessToolsV2 → registerDataDispatcher (14 tools → 1)\\n// import { registerDataAccessToolsV2 } from \\\"./tools/dataAccessV2.js\\\";\\nimport { registerDataDispatcher } from \\\"./tools/dispatchers/dataDispatcher.js\\\";\\n// REMOVED Tier 1: import { registerCalculationTools } from \\\"./tools/calculations.js\\\";\\n// DISPATCHER: registerManufacturingCalculationsV2 + AdvancedV2 + ToolpathV2 → registerCalcDispatcher (21 tools → 1)\\n// import { registerManufacturingCalculationsV2 } from \\\"./tools/calculationsV2.js\\\";\\n// import { registerAdvancedCalculationsV2 } from \\\"./tools/advancedCalculationsV2.js\\\";\\n// import { registerToolpathCalculationsV2 } from \\\"./tools/toolpathCalculationsV2.js\\\";\\n// REMOVED Tier 1: import { registerAgentTools } from \\\"./tools/agents.js\\\";\\n// REMOVED Tier 1: import { registerKnowledgeTools } from \\\"./tools/knowledge.js\\\";\\n// DISPATCHER: knowledgeV2 → covered by prism_skill_script dispatcher\\n// import { registerKnowledgeToolsV2 } from \\\"./tools/knowledgeV2.js\\\";\\n// DISPATCHER: stateTools → covered by prism_session dispatcher\\n// import { registerStateTools } from \\\"./tools/state.js\\\";\\n// REMOVED Tier 1: import { registerOrchestrationTools } from \\\"./tools/orchestration.js\\\";\\n// DISPATCHER: orchestrationV2 + swarmV2 → covered by prism_orchestrate dispatcher\\n// import { registerOrchestrationToolsV2 } from \\\"./tools/orchestrationV2.js\\\";\\n// import { registerSwarmToolsV2 } from \\\"./tools/swarmToolsV2.js\\\";\\n// DISPATCHER: hookV2 + hookV3 → covered by prism_hook dispatcher\\n// import { registerHookToolsV2 } from \\\"./tools/hookToolsV2.js\\\";\\n// import { registerHookToolsV3 } from \\\"./tools/hookToolsV3.js\\\";\\n// DISPATCHER: generatorTools → covered by prism_generator dispatcher\\n// import { registerGeneratorTools } from \\\"./tools/generatorTools.js\\\";\\n// DISPATCHER: registerValidationTools → registerValidationDispatcher (7 tools → 1)\\n// import { registerValidationTools } from \\\"./tools/validationTools.js\\\";\\n// DISPATCHER: registerOmegaTools → registerOmegaDispatcher (5 tools → 1)\\n// import { registerOmegaTools } from \\\"./tools/omegaTools.js\\\";\\n// DISPATCHER: registerManusTools → registerManusDispatcher (11 tools → 1)\\n// import { registerManusTools } from \\\"./tools/manusTools.js\\\";\\n// DISPATCHER: developmentProtocolTools → covered by prism_sp dispatcher\\n// import { registerDevelopmentProtocolTools } from \\\"./tools/developmentProtocolTools.js\\\";\\n// DISPATCHER: contextEngineeringTools → covered by prism_context dispatcher\\n// import { registerContextEngineeringTools } from \\\"./tools/contextEngineeringTools.js\\\";\\n// DISPATCHER: registerGsdTools → registerGsdDispatcher (6 tools → 1)\\n// import { registerGsdTools } from \\\"./tools/gsdTools.js\\\";\\n// DISPATCHER: hookManagementTools → covered by prism_hook dispatcher\\n// import { registerHookManagementTools } from \\\"./tools/hookManagementTools.js\\\";\\n\\n// DISPATCHER: 5 safety tools → registerSafetyDispatcher (29 tools → 1)\\n// import { registerCollisionTools } from \\\"./tools/collisionTools.js\\\";\\n// import { registerCoolantValidationTools } from \\\"./tools/coolantValidationTools.js\\\";\\n// import { registerSpindleProtectionTools } from \\\"./tools/spindleProtectionTools.js\\\";\\n// import { registerToolBreakageTools } from \\\"./tools/toolBreakageTools.js\\\";\\n// import { registerWorkholdingTools } from \\\"./tools/workholdingTools.js\\\";\\n// DISPATCHER: registerThreadTools → registerThreadDispatcher (12 tools → 1)\\n// import { registerThreadTools } from \\\"./tools/threadTools.js\\\";\\n\\n// DISPATCHER: skillToolsV2 + scriptToolsV2 → covered by prism_skill_script dispatcher\\n// import { registerSkillToolsV2 } from \\\"./tools/skillToolsV2.js\\\";\\n// import { registerScriptToolsV2 } from \\\"./tools/scriptToolsV2.js\\\";\\n// DISPATCHER: registerKnowledgeQueryTools → registerKnowledgeDispatcher (5 tools → 1)\\n// import { registerKnowledgeQueryTools } from \\\"./tools/knowledgeQueryTools.js\\\";\\n// DISPATCHER: registerToolpathTools → registerToolpathDispatcher (8 tools → 1)\\n// import { registerToolpathTools } from \\\"./tools/toolpathTools.js\\\";\\n// DISPATCHER: sessionLifecycleTools → covered by prism_session dispatcher\\n// import { registerSessionLifecycleTools } from \\\"./tools/sessionLifecycleTools.js\\\";\\n\\n// NEW: AutoPilot Orchestration\\n// DISPATCHER: registerAutoPilotTools → registerAutoPilotDispatcher (5 tools → 1)\\n// import { registerAutoPilotTools } from \\\"./tools/autoPilotTools.js\\\";\\n\\n// DISPATCHER: AutoPilot V2 → merged into autoPilotDispatcher\\n// import { registerAutoPilotToolsV2 } from \\\"./tools/autoPilotToolsV2.js\\\";\\n\\n// NEW: Ralph Loop Tools (3x scrutinize/validate)\\n// DISPATCHER: registerRalphLoopTools → registerRalphDispatcher (3 tools → 1)\\n// import { registerRalphLoopTools } from \\\"./tools/ralphLoopTools.js\\\";\\n\\n// NEW: Auto-Hook Integration — DISABLED: using autoHookWrapper.ts server proxy instead\\n// import { createHookedServer, getAutoHookStats, getAutoHookHistory } from \\\"./tools/autoHookIntegration.js\\\";\\n\\n// NEW: Document Management & Dev Workflow Tools (token-saving MCP-native tools)\\n// DISPATCHER: registerDocumentTools → registerDocumentDispatcher (7 tools → 1)\\n// import { registerDocumentTools } from \\\"./tools/documentTools.js\\\";\\n// DISPATCHER: registerDevWorkflowTools → registerDevDispatcher (7 tools → 1)\\n// import { registerDevWorkflowTools } from \\\"./tools/devWorkflowTools.js\\\";\\n\\n// DISPATCHER: Reasoning + Enforcement → covered by prism_guard dispatcher\\n// import { registerReasoningTools } from \\\"./tools/reasoningTools.js\\\";\\n// import { registerEnforcementTools } from \\\"./tools/enforcementTools.js\\\";\\n\\n// Phase 2A: Dispatcher Imports (70 tools → 4 dispatchers, ~60K token savings)\\nimport { registerSafetyDispatcher } from \\\"./tools/dispatchers/safetyDispatcher.js\\\";\\nimport { registerThreadDispatcher } from \\\"./tools/dispatchers/threadDispatcher.js\\\";\\nimport { registerToolpathDispatcher } from \\\"./tools/dispatchers/toolpathDispatcher.js\\\";\\nimport { registerCalcDispatcher } from \\\"./tools/dispatchers/calcDispatcher.js\\\";\\n// BATCH 2 DONE: dataDispatcher imported above with other tool imports\\n\\n// Phase 2A Batch 3: Quick Wins (9 dispatchers, 61 tools → 9)\\nimport { registerOmegaDispatcher } from \\\"./tools/dispatchers/omegaDispatcher.js\\\";\\nimport { registerValidationDispatcher } from \\\"./tools/dispatchers/validationDispatcher.js\\\";\\nimport { registerDocumentDispatcher } from \\\"./tools/dispatchers/documentDispatcher.js\\\";\\nimport { registerRalphDispatcher } from \\\"./tools/dispatchers/ralphDispatcher.js\\\";\\nimport { registerKnowledgeDispatcher } from \\\"./tools/dispatchers/knowledgeDispatcher.js\\\";\\nimport { registerDevDispatcher } from \\\"./tools/dispatchers/devDispatcher.js\\\";\\nimport { registerGsdDispatcher } from \\\"./tools/dispatchers/gsdDispatcher.js\\\";\\nimport { registerManusDispatcher } from \\\"./tools/dispatchers/manusDispatcher.js\\\";\\nimport { registerAutoPilotDispatcher } from \\\"./tools/dispatchers/autoPilotDispatcher.js\\\";\\n\\n// Phase 2B: Dispatcher Imports (128 tools → 8 dispatchers)\\nimport { registerOrchestrationDispatcher } from \\\"./tools/dispatchers/orchestrationDispatcher.js\\\";\\nimport { registerHookDispatcher } from \\\"./tools/dispatchers/hookDispatcher.js\\\";\\nimport { registerSpDispatcher } from \\\"./tools/dispatchers/spDispatcher.js\\\";\\nimport { registerContextDispatcher } from \\\"./tools/dispatchers/contextDispatcher.js\\\";\\nimport { registerSessionDispatcher } from \\\"./tools/dispatchers/sessionDispatcher.js\\\";\\nimport { registerSkillScriptDispatcher } from \\\"./tools/dispatchers/skillScriptDispatcher.js\\\";\\nimport { registerGeneratorDispatcher } from \\\"./tools/dispatchers/generatorDispatcher.js\\\";\\nimport { registerGuardDispatcher } from \\\"./tools/dispatchers/guardDispatcher.js\\\";\\n\\n// NEW: Auto-Hook Wrapper (Λ/Φ safety validation on calc tools)\\nimport { wrapToolWithAutoHooks, wrapWithUniversalHooks, getDispatchCount, AUTO_HOOK_CONFIG, registerAutoHookTools } from \\\"./tools/autoHookWrapper.js\\\";\\n\\n// Import registry manager for initialization\\nimport { registryManager } from \\\"./registries/index.js\\\";\\n\\n// Load environment variables\\ndotenv.config();\\n\\n// ============================================================================\\n// SERVER INITIALIZATION\\n// ============================================================================\\n\\nconst server = new McpServer({\\n  name: SERVER_NAME,\\n  version: SERVER_VERSION\\n});\\n\\n// ============================================================================\\n// TOOL REGISTRATION\\n// ============================================================================\\n\\n/**\\n * Register all PRISM tools with the MCP server\\n */\\nasync function registerTools(): Promise<void> {\\n  log.info(\\\"Registering PRISM MCP tools...\\\");\\n  \\n  // Initialize registries first\\n  log.info(\\\"Initializing data registries...\\\");\\n  await registryManager.initialize();\\n  \\n  // Session 43+: Bootstrap full formula (490) and machine (824) registries from data files\\n  try {\\n    const { bootstrapRegistries } = require(\\\"../dist/tools/registryBootstrapper.js\\\");\\n    const bootstrapReport = await bootstrapRegistries({\\n      formulaRegistry: registryManager.formulas,\\n      machineRegistry: registryManager.machines\\n    });\\n    log.info(`[BOOTSTRAP] Formulas: ${bootstrapReport.formulas.loaded} loaded, Machines: ${bootstrapReport.machines.loaded} loaded (${bootstrapReport.total_time_ms}ms)`);\\n  } catch (bootstrapErr: any) {\\n    log.warn(`[BOOTSTRAP] Registry bootstrap failed (non-fatal): ${bootstrapErr.message}`);\\n  }\\n\\n  // =========================================================================\\n  // UNIVERSAL AUTO-HOOK PROXY: Wraps ALL prism_* dispatchers with:\\n  //   1. Before/after dispatch hooks (DISPATCH-ACTION-VALIDATE, DISPATCH-PERF-TRACK)\\n  //   2. Category-specific hooks (CALC, FILE, STATE, AGENT, FORMULA)\\n  //   3. Error capture → REFL-002\\n  //   4. Cadence enforcement (todo@5, checkpoint@10, buffer zone warnings)\\n  //   5. Λ(x)/Φ(x) safety validation on calc tools specifically\\n  // =========================================================================\\n  const calcToolSet = new Set(AUTO_HOOK_CONFIG.calcTools);\\n  calcToolSet.add(\\\"prism_calc\\\");\\n  let autoHookCount = 0;\\n  let universalHookCount = 0;\\n  \\n  const originalTool = server.tool.bind(server);\\n  const proxiedTool = function(...args: any[]) {\\n    const toolName = args[0];\\n    \\n    if (typeof toolName === 'string' && toolName.startsWith('prism_')) {\\n      const handlerIndex = args.length - 1;\\n      const originalHandler = args[handlerIndex];\\n      \\n      if (typeof originalHandler === 'function') {\\n        // ALL prism_* tools get universal hooks (before/after, cadence, error capture)\\n        let wrapped = wrapWithUniversalHooks(toolName, originalHandler);\\n        universalHookCount++;\\n        \\n        // Calc tools ALSO get Λ(x)/Φ(x) safety validation layered on top\\n        if (calcToolSet.has(toolName)) {\\n          wrapped = wrapToolWithAutoHooks(toolName, wrapped);\\n          autoHookCount++;\\n          log.debug(`[AUTO-HOOK] Wrapped: ${toolName} with UNIVERSAL + Λ(x)/Φ(x) safety validation`);\\n        } else {\\n          log.debug(`[AUTO-HOOK] Wrapped: ${toolName} with UNIVERSAL hooks (before/after/cadence/error)`);\\n        }\\n        \\n        args[handlerIndex] = wrapped;\\n      }\\n    }\\n    \\n    return originalTool(...args);\\n  };\\n  \\n  // Replace server.tool with our proxy for the duration of registration\\n  (server as any).tool = proxiedTool;\\n\\n  // Data Access → Dispatcher (14 individual tools → 1 prism_data dispatcher)\\n  // registerDataAccessToolsV2(server);  // REPLACED by dispatcher\\n  registerDataDispatcher(server);\\n  log.debug(\\\"Registered: Data Dispatcher (14 actions via prism_data)\\\");\\n  \\n  // REMOVED Tier 1: Orchestration v1 (12 tools) — duplicated by orchestrationV2 + hookToolsV2/V3\\n  // registerOrchestrationTools(server);\\n  // log.debug(\\\"Registered: Orchestration tools (12 tools)\\\");\\n  \\n  // DISPATCHER: Orchestration + Swarm (14 tools → 1 dispatcher)\\n  // registerOrchestrationToolsV2(server);\\n  // registerSwarmToolsV2(server);\\n  registerOrchestrationDispatcher(server);\\n  log.debug(\\\"Registered: prism_orchestrate dispatcher (14 actions, replaces 14 individual tools)\\\");\\n  \\n  // DISPATCHER: Hook & Event Management (28 tools → 1 dispatcher)\\n  // registerHookToolsV2(server);\\n  // registerHookToolsV3(server);\\n  registerHookDispatcher(server);\\n  log.debug(\\\"Registered: prism_hook dispatcher (18 actions, replaces 28 individual tools)\\\");\\n  \\n  // DISPATCHER: Skills + Scripts + Knowledge V2 (23 tools → 1 dispatcher)\\n  // registerKnowledgeToolsV2(server);\\n  registerSkillScriptDispatcher(server);\\n  log.debug(\\\"Registered: prism_skill_script dispatcher (23 actions, replaces 23 individual tools)\\\");\\n  \\n  // =========================================================================\\n  // CALCULATION TOOLS — wrapped with Λ(x) auto-safety via server proxy\\n  // =========================================================================\\n  \\n  // DISPATCHER: Manufacturing Calculations (21 tools → 1 dispatcher) — AUTO-HOOKED via proxy\\n  // registerManufacturingCalculationsV2(server);\\n  // log.debug(\\\"Registered: Manufacturing Calculations V2 (8 tools) — Λ(x) AUTO-HOOKED\\\");\\n  \\n  // registerAdvancedCalculationsV2(server);\\n  // log.debug(\\\"Registered: Advanced Calculations V2 (6 tools) — Λ(x) AUTO-HOOKED\\\");\\n  \\n  // registerToolpathCalculationsV2(server);\\n  // log.debug(\\\"Registered: Toolpath Calculations V2 (7 tools) — Λ(x) AUTO-HOOKED\\\");\\n  registerCalcDispatcher(server);\\n  log.debug(\\\"Registered: prism_calc dispatcher (21 actions, replaces 21 individual tools) — Λ(x) AUTO-HOOKED\\\");\\n  \\n  // REMOVED Tier 1: Legacy Calculation Tools (4 tools) — duplicated by calculationsV2\\n  // registerCalculationTools(server);\\n  // log.debug(\\\"Registered: Legacy Calculation tools — Λ(x) AUTO-HOOKED\\\");\\n  \\n  // REMOVED Tier 1: Legacy Agent Tools (3 tools) — duplicated by orchestrationV2\\n  // registerAgentTools(server);\\n  // log.debug(\\\"Registered: Legacy Agent tools\\\");\\n  \\n  // REMOVED Tier 1: Legacy Knowledge Tools (6 tools) — duplicated by knowledgeV2\\n  // registerKnowledgeTools(server);\\n  // log.debug(\\\"Registered: Legacy Knowledge tools\\\");\\n  \\n  // DISPATCHER: Session State + Lifecycle (20 tools → 1 dispatcher)\\n  // registerStateTools(server);\\n  registerSessionDispatcher(server);\\n  log.debug(\\\"Registered: prism_session dispatcher (20 actions, replaces 20 individual tools)\\\");\\n  \\n  // DISPATCHER: Generator Tools (7 tools → 1 dispatcher)\\n  // registerGeneratorTools(server);\\n  registerGeneratorDispatcher(server);\\n  log.debug(\\\"Registered: prism_generator dispatcher (6 actions, replaces 7 individual tools)\\\");\\n  \\n  // DISPATCHER: Validation Tools (7 tools → 1 dispatcher)\\n  // registerValidationTools(server);\\n  registerValidationDispatcher(server);\\n  log.debug(\\\"Registered: prism_validate dispatcher (7 actions, replaces 7 individual tools)\\\");\\n  \\n  // DISPATCHER: Omega Integration Tools (5 tools → 1 dispatcher)\\n  // registerOmegaTools(server);\\n  registerOmegaDispatcher(server);\\n  log.debug(\\\"Registered: prism_omega dispatcher (5 actions, replaces 5 individual tools)\\\");\\n  \\n  // DISPATCHER: Manus Integration & Development Hooks (11 tools → 1 dispatcher)\\n  // registerManusTools(server);\\n  registerManusDispatcher(server);\\n  log.debug(\\\"Registered: prism_manus dispatcher (11 actions, replaces 11 individual tools)\\\");\\n  \\n  // DISPATCHER: Development Protocol / Superpowers (24 tools → 1 dispatcher)\\n  // registerDevelopmentProtocolTools(server);\\n  registerSpDispatcher(server);\\n  log.debug(\\\"Registered: prism_sp dispatcher (17 actions, replaces 24 individual tools)\\\");\\n  \\n  // DISPATCHER: Context Engineering / Manus Laws (14 tools → 1 dispatcher)\\n  // registerContextEngineeringTools(server);\\n  registerContextDispatcher(server);\\n  log.debug(\\\"Registered: prism_context dispatcher (14 actions, replaces 14 individual tools)\\\");\\n  \\n  // DISPATCHER: GSD Tools (6 tools → 1 dispatcher)\\n  // registerGsdTools(server);\\n  registerGsdDispatcher(server);\\n  log.debug(\\\"Registered: prism_gsd dispatcher (6 actions, replaces 6 individual tools)\\\");\\n  \\n  // Hook Management Tools — REPLACED by prism_hook dispatcher above\\n  // registerHookManagementTools(server);\\n  // log.debug(\\\"Registered: Hook Management tools (10 tools)\\\");\\n  \\n  // =========================================================================\\n  // DISPATCHER: SAFETY-CRITICAL TOOLS (29 tools → 1 dispatcher)\\n  // =========================================================================\\n  \\n  // registerCollisionTools(server);\\n  // registerCoolantValidationTools(server);\\n  // registerSpindleProtectionTools(server);\\n  // registerToolBreakageTools(server);\\n  // registerWorkholdingTools(server);\\n  registerSafetyDispatcher(server);\\n  log.debug(\\\"Registered: prism_safety dispatcher (29 actions, replaces 29 individual tools) - SAFETY CRITICAL\\\");\\n  \\n  // =========================================================================\\n  // NEW: ADDITIONAL TOOLS (48 tools)\\n  // =========================================================================\\n  \\n  // DISPATCHER: Thread Calculation Tools (12 tools → 1 dispatcher)\\n  // registerThreadTools(server);\\n  registerThreadDispatcher(server);\\n  log.debug(\\\"Registered: prism_thread dispatcher (12 actions, replaces 12 individual tools)\\\");\\n  \\n  // Skill Tools V2 — REPLACED by prism_skill_script dispatcher above\\n  // registerSkillToolsV2(server);\\n  // log.debug(\\\"Registered: Skill tools V2 (6 tools)\\\");\\n  \\n  // Script Tools V2 — REPLACED by prism_skill_script dispatcher above\\n  // registerScriptToolsV2(server);\\n  // log.debug(\\\"Registered: Script tools V2 (5 tools)\\\");\\n  \\n  // DISPATCHER: Knowledge Query Tools (5 tools → 1 dispatcher)\\n  // registerKnowledgeQueryTools(server);\\n  registerKnowledgeDispatcher(server);\\n  log.debug(\\\"Registered: prism_knowledge dispatcher (5 actions, replaces 5 individual tools)\\\");\\n  \\n  // DISPATCHER: Toolpath Strategy Tools (8 tools → 1 dispatcher)\\n  // registerToolpathTools(server);\\n  registerToolpathDispatcher(server);\\n  log.debug(\\\"Registered: prism_toolpath dispatcher (8 actions, replaces 8 individual tools)\\\");\\n  \\n  // =========================================================================\\n  // NEW: AUTOPILOT ORCHESTRATION (5 tools)\\n  // =========================================================================\\n  \\n  // DISPATCHER: AutoPilot Tools (5 tools → 1 dispatcher)\\n  // registerAutoPilotTools(server);\\n  registerAutoPilotDispatcher(server);\\n  log.debug(\\\"Registered: prism_autopilot_dispatch dispatcher (5 actions, replaces 5 individual tools)\\\");\\n  \\n  // DISPATCHER: AutoPilot V2 (3 tools) → merged into autoPilotDispatcher\\n  // registerAutoPilotToolsV2(server);\\n  // log.debug(\\\"Registered: AutoPilot V2 tools (3 tools) - Registry-aware orchestration\\\");\\n  \\n  // DISPATCHER: Ralph Loop Tools (3 tools → 1 dispatcher)\\n  // registerRalphLoopTools(server);\\n  registerRalphDispatcher(server);\\n  log.debug(\\\"Registered: prism_ralph dispatcher (3 actions, replaces 3 individual tools)\\\");\\n  \\n  // DISPATCHER: Session Lifecycle (12 tools) → covered by prism_session dispatcher\\n  // registerSessionLifecycleTools(server);\\n  // log.debug(\\\"Registered: Session Lifecycle tools (12 tools)\\\");\\n  \\n  // =========================================================================\\n  // NEW: DOCUMENT MANAGEMENT & DEV WORKFLOW (token-saving tools)\\n  // =========================================================================\\n  \\n  // DISPATCHER: Document Management Tools (7 tools → 1 dispatcher)\\n  // registerDocumentTools(server);\\n  registerDocumentDispatcher(server);\\n  log.debug(\\\"Registered: prism_doc dispatcher (7 actions, replaces 7 individual tools)\\\");\\n  \\n  // DISPATCHER: Dev Workflow Tools (7 tools → 1 dispatcher)\\n  // registerDevWorkflowTools(server);\\n  registerDevDispatcher(server);\\n  log.debug(\\\"Registered: prism_dev dispatcher (7 actions, replaces 7 individual tools)\\\");\\n  \\n  // DISPATCHER: Reasoning + Enforcement + AutoHook (8 tools → 1 dispatcher)\\n  // registerReasoningTools(server);\\n  // log.debug(\\\"Registered: Reasoning tools (3 tools) - prism_decision_log, prism_failure_library, prism_error_capture\\\");\\n  \\n  // Phase 1: Enforcement Tools (pre_write_gate, pre_call_validate, pre_write_diff)\\n  // registerEnforcementTools(server);\\n  // log.debug(\\\"Registered: Enforcement tools (3 tools) - prism_pre_write_gate, prism_pre_call_validate, prism_pre_write_diff\\\");\\n  \\n  // Auto-Hook diagnostic tools (must register AFTER proxy is active so they're NOT wrapped)\\n  // registerAutoHookTools(server);\\n  // log.debug(\\\"Registered: Auto-Hook diagnostic tools (2 tools) - prism_autohook_status, prism_autohook_test\\\");\\n  \\n  // Guard Dispatcher replaces all 8 above\\n  registerGuardDispatcher(server);\\n  log.debug(\\\"Registered: prism_guard dispatcher (8 actions, replaces reasoning + enforcement + autoHook)\\\");\\n  \\n  log.info(`All PRISM tools registered: 21 dispatchers + 1 autoHook proxy = ~22 tool definitions (consolidating ~300+ actions)`);\\n  \\n  // Restore original server.tool and report auto-hook stats\\n  (server as any).tool = originalTool;\\n  log.info(`[AUTO-HOOK] ${universalHookCount} dispatchers wrapped with UNIVERSAL hooks (before/after/cadence/error)`);\\n  log.info(`[AUTO-HOOK] ${autoHookCount} calculation tools wrapped with additional Λ(x)/Φ(x) safety validation`);\\n  log.info(`[AUTO-HOOK] Global dispatch counter active — cadence: todo@5, checkpoint@10, buffer zones enforced`);\\n}\\n\\n// ============================================================================\\n// TRANSPORT HANDLERS\\n// ============================================================================\\n\\n/**\\n * Run server with stdio transport (for local MCP clients)\\n */\\nasync function runStdio(): Promise<void> {\\n  log.info(`Starting ${SERVER_NAME} v${SERVER_VERSION} (stdio mode)`);\\n  log.info(SERVER_DESCRIPTION);\\n  \\n  await registerTools();\\n  \\n  const transport = new StdioServerTransport();\\n  await server.connect(transport);\\n  \\n  log.info(\\\"Server running on stdio\\\");\\n}\\n\\n/**\\n * Run server with HTTP transport (for remote access)\\n */\\nasync function runHTTP(): Promise<void> {\\n  log.info(`Starting ${SERVER_NAME} v${SERVER_VERSION} (HTTP mode)`);\\n  log.info(SERVER_DESCRIPTION);\\n  \\n  await registerTools();\\n  \\n  const app = express();\\n  app.use(express.json());\\n  \\n  // Health check endpoint\\n  app.get(\\\"/health\\\", (_, res) => {\\n    res.json({ \\n      status: \\\"healthy\\\", \\n      server: SERVER_NAME, \\n      version: SERVER_VERSION \\n    });\\n  });\\n  \\n  // MCP endpoint\\n  app.post(\\\"/mcp\\\", async (req, res) => {\\n    const transport = new StreamableHTTPServerTransport({\\n      sessionIdGenerator: undefined,\\n      enableJsonResponse: true\\n    });\\n    \\n    res.on(\\\"close\\\", () => transport.close());\\n    \\n    await server.connect(transport);\\n    await transport.handleRequest(req, res, req.body);\\n  });\\n  \\n  const port = parseInt(process.env.PORT || \\\"3000\\\", 10);\\n  app.listen(port, () => {\\n    log.info(`MCP server running on http://localhost:${port}/mcp`);\\n  });\\n}\\n\\n// ============================================================================\\n// MAIN ENTRY\\n// ============================================================================\\n\\nasync function main(): Promise<void> {\\n  const transport = process.env.TRANSPORT || \\\"stdio\\\";\\n  \\n  try {\\n    if (transport === \\\"http\\\") {\\n      await runHTTP();\\n    } else {\\n      await runStdio();\\n    }\\n  } catch (error) {\\n    log.error(\\\"Server startup failed\\\", error);\\n    process.exit(1);\\n  }\\n}\\n\\n// Handle uncaught errors\\nprocess.on(\\\"uncaughtException\\\", (error) => {\\n  log.error(\\\"Uncaught exception\\\", error);\\n  process.exit(1);\\n});\\n\\nprocess.on(\\\"unhandledRejection\\\", (reason) => {\\n  log.error(\\\"Unhandled rejection\\\", reason as Error);\\n  process.exit(1);\\n});\\n\\n// Start server\\nmain();\\n\"\n}"
}