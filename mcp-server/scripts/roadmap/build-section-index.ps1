# W1-2: Build ROADMAP_SECTION_INDEX.md from placed anchors
$roadmapDir = "C:\PRISM\mcp-server\data\docs\roadmap"
$outputPath = Join-Path $roadmapDir "ROADMAP_SECTION_INDEX.md"

$output = @()
$output += "# ROADMAP SECTION INDEX"
$output += "# Auto-generated by place-anchors pipeline. Rebuild: scripts/roadmap/rebuild-section-index.ps1"
$output += "# Load this file (~1.5K tokens) instead of full phase docs to navigate by section."
$output += ""
$output += "| File | Anchor | Line | Section |"
$output += "|------|--------|------|---------|"

$totalEntries = 0

$files = Get-ChildItem "$roadmapDir\*.md" | Where-Object { $_.Name -ne "ROADMAP_SECTION_INDEX.md" } | Sort-Object Name

foreach ($file in $files) {
    $lines = Get-Content $file.FullName -Encoding UTF8
    $currentAnchor = $null
    $currentAnchorLine = 0
    
    for ($i = 0; $i -lt $lines.Count; $i++) {
        $line = $lines[$i]
        
        if ($line -match '<!-- ANCHOR:\s*(\S+)\s*-->') {
            $currentAnchor = $Matches[1]
            $currentAnchorLine = $i + 1  # 1-based
        }
        elseif ($currentAnchor -and $line -match '^(#{2,3})\s+(.+)') {
            $sectionTitle = $Matches[2].Trim()
            $output += "| $($file.Name) | $currentAnchor | $currentAnchorLine | $sectionTitle |"
            $totalEntries++
            $currentAnchor = $null
        }
    }
}

$output += ""
$output += "**Total entries: $totalEntries**"

Set-Content -Path $outputPath -Value $output -Encoding UTF8
Write-Host "Built ROADMAP_SECTION_INDEX.md with $totalEntries entries"
